<!DOCTYPE html>
<html>
<head>
    <title>Diagnostic Firebase</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { 
            max-width: 800px; 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
        }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 15px 30px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .button:hover { transform: translateY(-2px); }
        
        .solution {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        h1 { color: #667eea; text-align: center; margin-bottom: 30px; }
        .log { 
            background: #2d3748; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: monospace; 
            font-size: 12px; 
            max-height: 300px; 
            overflow-y: auto; 
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Firebase</h1>
        
        <div id="status" class="status info">
            D√©marrage du diagnostic...
        </div>
        
        <div class="solution">
            <h3>üîß Solutions rapides :</h3>
            <button class="button" onclick="testFirebaseConnection()">
                üîç Tester Firebase
            </button>
            <button class="button" onclick="checkExtensions()">
                üß© V√©rifier Extensions
            </button>
            <button class="button" onclick="clearCache()">
                üóëÔ∏è Nettoyer Cache
            </button>
            <button class="button" onclick="forceOfflineMode()">
                üì¥ Mode Hors Ligne
            </button>
        </div>
        
        <div class="log" id="log">
            === Diagnostic Firebase ===
        </div>
        
        <div class="solution">
            <h3>üìã Solutions manuelles :</h3>
            <ol>
                <li><strong>D√©sactiver les extensions :</strong> uBlock Origin, AdBlock, etc.</li>
                <li><strong>Navigation priv√©e :</strong> Essaie en mode incognito</li>
                <li><strong>V√©rifier la connexion :</strong> Assure-toi d'avoir internet</li>
                <li><strong>Red√©marrer le navigateur :</strong> Ferme et rouvre compl√®tement</li>
                <li><strong>Vider le cache :</strong> Ctrl+Shift+Delete ‚Üí Tout effacer</li>
            </ol>
        </div>
    </div>
    
    <script>
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `\n[${timestamp}] ${message}`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        async function testFirebaseConnection() {
            updateStatus('üîç Test de connexion Firebase...', 'info');
            log('Test de connexion Firebase...');
            
            try {
                // Test 1: Connexion HTTP
                log('Test 1: Connexion HTTP √† firestore.googleapis.com');
                const response = await fetch('https://firestore.googleapis.com', { 
                    mode: 'no-cors',
                    method: 'HEAD'
                });
                log('‚úÖ Connexion HTTP r√©ussie');
                
                // Test 2: Connexion WebSocket
                log('Test 2: Test WebSocket...');
                const ws = new WebSocket('wss://firestore.googleapis.com');
                
                ws.onopen = () => {
                    log('‚úÖ WebSocket ouvert');
                    ws.close();
                };
                
                ws.onerror = (error) => {
                    log('‚ùå Erreur WebSocket: ' + error);
                };
                
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        log('‚ö†Ô∏è WebSocket en attente (peut √™tre bloqu√©)');
                    }
                }, 3000);
                
                updateStatus('‚úÖ Firebase accessible', 'success');
                
            } catch (error) {
                log('‚ùå Erreur Firebase: ' + error.message);
                updateStatus('‚ùå Firebase bloqu√©', 'error');
            }
        }
        
        function checkExtensions() {
            updateStatus('üß© V√©rification des extensions...', 'info');
            log('V√©rification des extensions...');
            
            // D√©tecter les extensions communes
            const extensions = [
                { name: 'uBlock Origin', test: () => typeof uBlock !== 'undefined' },
                { name: 'AdBlock', test: () => typeof adblock !== 'undefined' },
                { name: 'AdBlock Plus', test: () => typeof abp !== 'undefined' },
                { name: 'Ghostery', test: () => typeof ghostery !== 'undefined' },
                { name: 'Privacy Badger', test: () => typeof privacyBadger !== 'undefined' }
            ];
            
            let foundExtensions = [];
            extensions.forEach(ext => {
                try {
                    if (ext.test()) {
                        foundExtensions.push(ext.name);
                        log(`‚ö†Ô∏è Extension d√©tect√©e: ${ext.name}`);
                    }
                } catch (e) {
                    // Extension non d√©tect√©e
                }
            });
            
            if (foundExtensions.length > 0) {
                updateStatus(`‚ö†Ô∏è Extensions d√©tect√©es: ${foundExtensions.join(', ')}`, 'warning');
                log('üí° Suggestion: D√©sactive temporairement ces extensions');
            } else {
                updateStatus('‚úÖ Aucune extension bloquante d√©tect√©e', 'success');
            }
        }
        
        function clearCache() {
            updateStatus('üóëÔ∏è Nettoyage du cache...', 'info');
            log('Nettoyage du cache...');
            
            try {
                // Nettoyer localStorage
                localStorage.clear();
                log('‚úÖ localStorage nettoy√©');
                
                // Nettoyer sessionStorage
                sessionStorage.clear();
                log('‚úÖ sessionStorage nettoy√©');
                
                // Nettoyer les cookies
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                log('‚úÖ Cookies nettoy√©s');
                
                updateStatus('‚úÖ Cache nettoy√© avec succ√®s', 'success');
                
                setTimeout(() => {
                    log('üîÑ Rechargement de la page dans 3 secondes...');
                    setTimeout(() => window.location.reload(), 3000);
                }, 1000);
                
            } catch (error) {
                log('‚ùå Erreur lors du nettoyage: ' + error.message);
                updateStatus('‚ùå Erreur lors du nettoyage', 'error');
            }
        }
        
        function forceOfflineMode() {
            updateStatus('üì¥ Activation du mode hors ligne...', 'info');
            log('Activation du mode hors ligne...');
            
            try {
                // Cr√©er un utilisateur propri√©taire hors ligne
                const ownerUser = {
                    id: 'owner-offline-' + Date.now(),
                    firstName: 'Propri√©taire',
                    lastName: 'Hors Ligne',
                    email: 'proprietaire.offline@musique.com',
                    role: 'owner',
                    subscriptionStatus: 'active',
                    isActive: true,
                    createdAt: new Date().toISOString(),
                    picture: null,
                    groups: [],
                    settings: {},
                    lastLogin: new Date().toISOString(),
                    instrument: null,
                    teacherId: null,
                    preferences: {},
                    offline: true
                };
                
                localStorage.setItem('tempOwner', JSON.stringify(ownerUser));
                log('‚úÖ Utilisateur propri√©taire cr√©√© (hors ligne)');
                
                updateStatus('‚úÖ Mode hors ligne activ√© - Redirection...', 'success');
                
                setTimeout(() => {
                    window.location.href = 'http://localhost:5174/teacher';
                }, 2000);
                
            } catch (error) {
                log('‚ùå Erreur mode hors ligne: ' + error.message);
                updateStatus('‚ùå Erreur mode hors ligne', 'error');
            }
        }
        
        // Diagnostic automatique au chargement
        window.onload = function() {
            log('=== Diagnostic Firebase ===');
            log('Navigateur: ' + navigator.userAgent);
            log('URL: ' + window.location.href);
            log('Timestamp: ' + new Date().toISOString());
            
            // Test automatique
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
            
            setTimeout(() => {
                checkExtensions();
            }, 3000);
        };
    </script>
</body>
</html> 